{% extends "base.html" %}
{% block content %}
<div class="results-wrapper" style="height: 80vh; display: flex; gap: 20px;">
    
    <!-- LEFT: Scrollable list of video cards -->
    <div class="col-left flex-grow-1 overflow-auto pe-3">
        <div class="sticky-top bg-dark mb-4" style="top:0; z-index:5; border-radius: 6px;">
            <h2 class="fw-bold text-center py-3 mb-0">üéµ Results for "{{ song_query }}"</h2>
        </div>
        {% if videos %}
            <h3 class="fw-bold mt-4">Cover Videos ({{ cover_count }})
                <span class="info-icon" 
                      data-bs-toggle="tooltip" 
                      data-bs-html="true" 
                      title="<strong>Filtered Covers:</strong><br>
                             These are results identified as covers. The filter prioritizes keywords like 
                             <code>cover</code>, <code>Ê≠å„Å£„Å¶„Åø„Åü</code>, <code>Âºæ„ÅÑ„Å¶„Åø„Åü</code>, etc.,
                             while removing 'noise' (see 'Other Results' below).">
                    <i class="bi bi-info-circle-fill"></i>
                </span>
            </h3>
            {% for video in cover_videos %}
            <div class="video-card">
                <div class="thumbnail-wrapper">
                    <a href="{{ video.url }}" target="_blank">
                        <img src="{{ video.thumbnail }}" alt="thumbnail" class="thumbnail">
                        <span class="video-duration">{{ video.duration }}</span>
                        <div class="play-overlay">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                    </a>
                </div>
                <div class="video-info">
                    <a href="{{ video.url }}" target="_blank">
                        <h5>{{ video.title }}</h5>
                    </a>
                    <p class="mb-1">By: {{ video.channel }}</p>
                    {% if video.rule_name %}
                    <span class="cluster-badge" 
                          data-bs-toggle="tooltip"
                          data-bs-html="true"
                          title="<strong>Stable (Rule-Based):</strong><br>
                                 Category is determined by a fixed list of keywords 
                                 (e.g., 'piano', 'vocal', 'band'). Fast, stable, and predictable.">
                        <i class="{{ video.rule_icon }} me-1"></i>
                        {{ video.rule_name }}
                    </span>
                    {% endif %}
                    {% if video.ml_name %}
                    <span class="small-badge" 
                          data-bs-toggle="tooltip"
                          data-bs-html="true"
                          title="<strong>ML Cluster (Unsupervised):</strong><br>
                                 Category is found by an ML model (KMeans) that groups videos by *all* text. 
                                 It's 'volatile' as it changes with every search, but can find hidden patterns.">
                        <i class="bi bi-robot me-1"></i>
                        {{ video.ml_name }}
                    </span>
                    {% endif %}
                    <br>
                    <small>{{  "{:,}".format(video.views)  }} views ‚Ä¢ Uploaded {{ video.upload_date }}</small>
                </div>
            </div>
            {% endfor %}
            
            
            <h3 class="fw-bold mt-5 text-muted">Other Results ({{ total_results - cover_count }})
                <span class="info-icon" 
                      data-bs-toggle="tooltip" 
                      data-bs-html="true" 
                      title="<strong>Filtered Noise:</strong><br>
                             Videos filtered out as 'noise'. This includes: <br>
                             &bull; Official Music Videos (MVs) <br>
                             &bull; Lyric videos (<code>lyrics</code>) <br>
                             &bull; Karaoke tracks (<code>„Ç´„É©„Ç™„Ç±</code>) <br>
                             &bull; Live performances (<code>live</code>) <br>
                             &bull; Other non-cover content.">
                    <i class="bi bi-info-circle-fill"></i>
                </span>
            </h3>
            {% for video in noise_videos %}
            <div class="video-card">
                <div class="thumbnail-wrapper">
                    <a href="{{ video.url }}" target="_blank">
                        <img src="{{ video.thumbnail }}" alt="thumbnail" class="thumbnail">
                        <span class="video-duration">{{ video.duration }}</span>
                        <div class="play-overlay">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                    </a>
                </div>
                <div class="video-info">
                    <a href="{{ video.url }}" target="_blank">
                        <h5>{{ video.title }}</h5>
                    </a>
                    <p class="mb-1">By: {{ video.channel }}</p>
                    <small>{{  "{:,}".format(video.views)  }} views ‚Ä¢ Uploaded {{ video.upload_date }}</small>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No results found. Try another song title.</p>
        {% endif %}
    </div>

    <!-- RIGHT: Analytics panel with its own scroll -->
    <div class="col-right overflow-auto">
        <div class="analytics-panel">
            <h4>üìä Trend Analytics</h4>
            <p>Trend Score:
                <span class="info-icon" 
                      data-bs-toggle="tooltip" 
                      data-bs-html="true" 
                      title="<strong>Trend Score Formula:</strong><br>
                             <code>Score = ( (Recency * 0.4) + (Views * 0.4) + (Volume * 0.2) ) * 100</code>
                             <br><br>
                             &bull; <strong>Recency:</strong> Avg. recency of covers (1 for new, 0 for >1yr old).<br>
                             &bull; <strong>Views:</strong> Log-normalized total views (<code>log(Views+1) / 15</code>).<br>
                             &bull; <strong>Volume:</strong> Number of covers, capped at 50 (<code>min(Covers, 50) / 50</code>).
                             <br><br>
                             A score of <strong>100</strong> means high recent activity. A <strong>0</strong> means no/old covers.">
                    <i class="bi bi-info-circle-fill"></i>
                </span>
            </p>
            <div class="trend-score mb-3">{{ trend_score }}</div>
            <p class="trend-summary">{{ trend_summary }}</p>
            <hr>
            <p>Average Views: 
                <strong>
                    {{ "{:,}".format((cover_videos|map(attribute='views')|sum / cover_videos|length)|int) if cover_videos else 0 }}
                </strong>
            </p>
            <hr>
            <h3>üìÜ Monthly Upload Frequency</h3>
            <canvas id="uploadChart" width="400" height="250"></canvas>
            <hr>

            {% if top_keywords or plot_data %}
            <h3>
                ML Cluster Analysis
                <span class="info-icon" 
                      data-bs-toggle="tooltip" 
                      data-bs-html="true" 
                      title="<strong>ML Analysis Pipeline:</strong><br>
                             1. Video text is cleaned and vectorized (TF-IDF).<br>
                             2. A <strong>KMeans</strong> model finds 4 clusters.<br>
                             3. <strong>Top Keywords</strong> are the most important words for each cluster's center.<br>
                             4. The <strong>Cluster Plot</strong> is a 2D visualization (t-SNE) of the high-dimensional text data.">
                    <i class="bi bi-info-circle-fill"></i>
                </span>
            </h3>
            {% endif %}

            {% if top_keywords %}
            <h5 class="mt-3">üîë Top ML Keywords</h5>
            <div class="keyword-list">
                {% for cluster_name, keywords in top_keywords.items() %}
                    <strong>{{ cluster_name }}:</strong>
                    <p>{{ keywords|join(', ') }}</p>
                {% endfor %}
            </div>
            {% endif %}

            {% if plot_data %}
            <h5 class="mt-3">üó∫Ô∏è Cluster Plot (t-SNE)</h5>
            <canvas id="clusterPlot" width="400" height="250"></canvas>
            <hr>
            {% endif %}

            <h5>üî• Top 3 Most Viewed Covers</h5>
            <ol class="top-covers-list">
                {% for t in top_covers %}
                <li class="top-cover-item">
                    <a href="{{ t.url }}" target="_blank">
                        <img src="{{ t.thumbnail }}" alt="thumbnail" class="top-cover-thumbnail">
                    </a>
                    <div class="top-cover-info">
                        <a href="{{ t.url }}" target="_blank" class="top-cover-title" title="{{ t.title }}">
                            {{ t.title }}
                        </a>
                        <small class="top-cover-channel">by {{ t.channel }}</small>
                        <small class="top-cover-views">{{ "{:,}".format(t.views) }} views</small>
                    </div>
                </li>
                {% endfor %}
            </ol>
        </div>
    </div>

</div>

{% endblock %}

<!-- --- CHANGED: Moved all page scripts into the new 'scripts' block --- -->
{% block scripts %}
<script>
    // --- UPLOAD CHART (Existing) ---
    const ctx = document.getElementById('uploadChart').getContext('2d');
    const months = {{ months|tojson }};
    const uploadCounts = {{ upload_counts|tojson }};

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months,
            datasets: [{
                label: 'Number of Covers',
                data: uploadCounts,
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            scales: { x: { ticks: { color: '#ddd' }, grid: { color: '#444' } }, y: { beginAtZero: true, ticks: { color: '#ddd' }, grid: { color: '#444' } } },
            plugins: { legend: { labels: { color: '#ddd' } } }
        }
    });

    // --- CLUSTER PLOT SCRIPT (Existing) ---
    const plotData = {{ plot_data|tojson }};
    if (plotData && plotData.length > 0) {
        const clusterColors = {
            'Vocal cover': 'rgba(75, 192, 192, 0.8)', // Teal
            'Instrumental': 'rgba(255, 159, 64, 0.8)', // Orange
            'Acoustic / Soft': 'rgba(153, 102, 255, 0.8)', // Purple
            'Band / Full Arrangement': 'rgba(255, 99, 132, 0.8)', // Red
            'Other / Remix': 'rgba(100, 100, 100, 0.8)' // Gray
        };

        const scatterData = {
            datasets: Object.keys(clusterColors).map(label => ({
                label: label,
                data: plotData.filter(d => d.label === label),
                backgroundColor: clusterColors[label],
                pointRadius: 6,
                pointHoverRadius: 8
            }))
        };

        const ctxPlot = document.getElementById('clusterPlot').getContext('2d');
        new Chart(ctxPlot, {
            type: 'scatter',
            data: scatterData,
            options: {
                scales: {
                    x: { ticks: { display: false, color: '#ddd' }, grid: { color: '#444' } },
                    y: { ticks: { display: false, color: '#ddd' }, grid: { color: '#444' } }
                },
                plugins: {
                    legend: { labels: { color: '#ddd' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                // Show title in tooltip
                                return context.raw.title;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- Tooltip Initialization Script ---
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl, {
        customClass: 'info-tooltip' // Apply our custom dark-mode style
      })
    })
</script>
{% endblock %}